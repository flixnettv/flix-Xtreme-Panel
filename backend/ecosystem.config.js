/**
 * PM2 Process Manager Configuration
 * ecosystem.config.js
 * إعدادات تشغيل التطبيق بـ PM2 - مُحسّنة لـ 1GB RAM
 */

module.exports = {
  apps: [
    {
      // اسم التطبيق في PM2
      name: "xtreme-panel",
      
      // نقطة الدخول للتطبيق
      script: "./server.js",
      
      // ==========================================
      // ⚠️ تحسينات للرام المحدود (1GB)
      // ==========================================
      
      // عدد النسخ: 1 فقط (مش cluster) عشان نوفر الرام
      instances: 1,
      
      // وضع التشغيل: fork (مش cluster)
      exec_mode: "fork",
      
      // إعادة التشغيل التلقائي لو استهلك الرام أكتر من 800MB
      max_memory_restart: "800M",
      
      // ==========================================
      // إعدادات البيئة
      // ==========================================
      env: {
        NODE_ENV: "production",
        PORT: 5000
      },
      
      // ==========================================
      // إعدادات السجلات (Logs)
      // ==========================================
      // مسار ملف السجلات
      output: "./logs/out.log",
      error: "./logs/error.log",
      log: "./logs/combined.log",
      
      // تدوير السجلات: 10MB لكل ملف، الاحتفاظ بآخر 5 ملفات
      log_rotate: true,
      max_size: "10M",
      retain: "5",
      
      // ==========================================
      // إعدادات المراقبة والإعادة
      // ==========================================
      // إعادة التشغيل التلقائي عند التعطل
      autorestart: true,
      
      // وقت الانتظار قبل إعادة التشغيل (ملي ثانية)
      restart_delay: 4000,
      
      // وقت الانتظار عشان يعتبر التطبيق "شغال"
      min_uptime: "10s",
      
      // عدد محاولات إعادة التشغيل قبل التوقف
      max_restarts: 10,
      
      // ==========================================
      // إعدادات الأداء
      // ==========================================
      // عدد الطلبات في الانتظار
      listen_timeout: 8000,
      kill_timeout: 5000,
      
      // منع تشغيل أكثر من نسخة
      singleton: true,
      instance_var: "INSTANCE_ID"
    }
  ]
};